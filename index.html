async function createProject() {
    const projectName = document.getElementById('projectName').value;
    const responseDiv = document.getElementById('response');
    const progress = document.getElementById('progress');
    const progressText = document.getElementById('progressText');
    const createButton = document.getElementById('createButton');

    if (!projectName) {
        if (responseDiv) responseDiv.innerText = 'Введите название проекта.';
        addLog('Ошибка: Не указано название проекта');
        return;
    }
    if (projectFiles.length === 0) {
        if (responseDiv) responseDiv.innerText = 'Загрузите хотя бы один файл.';
        addLog('Ошибка: Не загружены файлы');
        return;
    }
    if (!previewFile && !projectFiles.find(f => f.name.toLowerCase() === 'preview.png')) {
        if (responseDiv) responseDiv.innerText = 'Ошибка: Загрузите файл preview.png.';
        addLog('Ошибка: preview.png не загружен');
        return;
    }

    // Check for duplicate project
    try {
        const projectCheck = await fetch(`https://api.github.com/repos/Endermanik13/AurumBotFiles/contents/projects/${encodeURIComponent(projectName)}.json`, {
            headers: {
                'Authorization': `Bearer ${githubToken}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });
        if (projectCheck.status === 200) {
            if (responseDiv) responseDiv.innerText = `Ошибка: Проект "${projectName}" уже существует.`;
            addLog(`Ошибка: Проект "${projectName}" уже существует`);
            return;
        } else if (projectCheck.status !== 404) {
            if (responseDiv) responseDiv.innerText = `Ошибка проверки дублирования: ${projectCheck.statusText}`;
            addLog(`Ошибка проверки дублирования: ${projectCheck.statusText}`);
            return;
        }
    } catch (error) {
        if (responseDiv) responseDiv.innerText = `Ошибка проверки дублирования: ${error.message}`;
        addLog(`Ошибка проверки дублирования: ${error.message}`);
        return;
    }

    if (createButton) createButton.disabled = true;
    if (createButton) createButton.classList.add('hidden');
    showSection('loadingSection', ['previewSection', 'projectForm', 'projectManagementSection', 'loginForm', 'completedSection']);
    if (progress) progress.style.width = '0%';
    if (progressText) progressText.innerText = '0% (0/5 этапа)';
    addLog('Начато создание проекта');

    try {
        // Step 1: Process and upload files
        const fileMetadata = [];
        const isSingleZip = projectFiles.length === 1 && projectFiles[0].name.endsWith('.zip');
        const onlyPaintFiles = !isSingleZip && projectFiles.every(f => f.name.endswith('.png') || f.name.endswith('.pdn'));
        // Ensure preview.png is included
        if (previewFile) {
            projectFiles = projectFiles.filter(f => f.name !== previewFile.name);
            projectFiles.unshift(previewFile); // Add preview.png first
        }
        for (const file of projectFiles) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            await new Promise(resolve => reader.onload = resolve);
            const base64Content = reader.result.split(',')[1];
            const path = file.webkitRelativePath || file.name;
            const isPaintFile = path.endsWith('.png') || path.endsWith('.pdn');
            const uploadPath = isSingleZip ? `${encodeURIComponent(projectName)}/${encodeURIComponent(path)}` : 
                              onlyPaintFiles ? `${encodeURIComponent(projectName)}/${encodeURIComponent(path)}` : 
                              `${encodeURIComponent(projectName)}/${isPaintFile ? 'Итог' : 'other'}/${encodeURIComponent(path)}`;
            const uploadResponse = await fetch(`https://api.github.com/repos/Endermanik13/AurumBotFiles/contents/${uploadPath}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                    message: `Add ${path} to ${projectName}`,
                    content: base64Content
                })
            });
            if (uploadResponse.status !== 201) {
                if (responseDiv) responseDiv.innerText = `Ошибка загрузки ${path}: ${uploadResponse.statusText}`;
                addLog(`Ошибка загрузки ${path}: ${uploadResponse.statusText}`);
                showSection('projectManagementSection', ['loadingSection']);
                if (createButton) {
                    createButton.disabled = false;
                    createButton.classList.remove('hidden');
                }
                return;
            }
            fileMetadata.push({
                path: path,
                size_mb: (file.size / (1024 * 1024)).toFixed(2),
                download_url: `https://raw.githubusercontent.com/Endermanik13/AurumBotFiles/main/${uploadPath}`
            });
            addLog(`Файл ${path} загружен в ${uploadPath}`);
        }
        if (progress) progress.style.width = '20%';
        if (progressText) progressText.innerText = '20% (1/5 этапа)';

        // Step 2: Trigger workflow
        await new Promise(resolve => setTimeout(resolve, 1000));
        if (progress) progress.style.width = '40%';
        if (progressText) progressText.innerText = '40% (2/5 этапа)';
        addLog('Запуск workflow...');

        const dispatchResponse = await fetch('https://api.github.com/repos/Endermanik13/AurumBotFiles/dispatches', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${githubToken}`,
                'Accept': 'application/vnd.github.v3+json'
            },
            body: JSON.stringify({
                event_type: 'create-project',
                client_payload: {
                    project_name: projectName,
                    file_metadata: JSON.stringify(fileMetadata),
                    is_single_zip: isSingleZip
                }
            })
        });

        if (dispatchResponse.status !== 204) {
            if (responseDiv) responseDiv.innerText = `Ошибка запуска workflow: ${dispatchResponse.statusText}`;
            addLog(`Ошибка запуска workflow: ${dispatchResponse.statusText}`);
            showSection('projectManagementSection', ['loadingSection']);
            if (createButton) {
                createButton.disabled = false;
                createButton.classList.remove('hidden');
            }
            return;
        }

        // Step 3: Wait for workflow to start
        await new Promise(resolve => setTimeout(resolve, 2000));
        if (progress) progress.style.width = '60%';
        if (progressText) progressText.innerText = '60% (3/5 этапа)';
        addLog('Ожидание старта workflow...');

        // Step 4: Poll for workflow completion
        let workflowCompleted = false;
        let workflowId = null;
        for (let i = 0; i < 45; i++) {
            const runsResponse = await fetch('https://api.github.com/repos/Endermanik13/AurumBotFiles/actions/runs', {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            if (runsResponse.status !== 200) {
                if (responseDiv) responseDiv.innerHTML = `Ошибка проверки workflow: ${runsResponse.statusText}. <a href="https://github.com/Endermanik13/AurumBotFiles/actions" target="_blank">Проверить логи Actions</a>`;
                addLog(`Ошибка проверки workflow: ${runsResponse.statusText}`);
                showSection('projectManagementSection', ['loadingSection']);
                if (createButton) {
                    createButton.disabled = false;
                    createButton.classList.remove('hidden');
                }
                return;
            }
            const runs = await runsResponse.json();
            const run = runs.workflow_runs.find(r => r.event === 'repository_dispatch' && r.status !== 'completed');
            if (run) {
                workflowId = run.id;
            } else if (workflowId) {
                const runStatus = await fetch(`https://api.github.com/repos/Endermanik13/AurumBotFiles/actions/runs/${workflowId}`, {
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                const runData = await runStatus.json();
                if (runData.status === 'completed') {
                    if (runData.conclusion === 'success') {
                        workflowCompleted = true;
                    } else {
                        if (responseDiv) responseDiv.innerHTML = `Ошибка: Workflow завершился с ошибкой (${runData.conclusion}). <a href="https://github.com/Endermanik13/AurumBotFiles/actions/runs/${workflowId}" target="_blank">Проверить логи Actions</a>`;
                        addLog(`Ошибка: Workflow завершился с ошибкой (${runData.conclusion})`);
                        showSection('projectManagementSection', ['loadingSection']);
                        if (createButton) {
                            createButton.disabled = false;
                            createButton.classList.remove('hidden');
                        }
                        return;
                    }
                    break;
                }
            }
            await new Promise(resolve => setTimeout(resolve, 2000));
        }

        if (progress) progress.style.width = '80%';
        if (progressText) progressText.innerText = '80% (4/5 этапа)';
        addLog('Workflow завершён');

        if (!workflowCompleted) {
            if (responseDiv) responseDiv.innerHTML = `Ошибка: Workflow не завершился вовремя. <a href="https://github.com/Endermanik13/AurumBotFiles/actions" target="_blank">Проверить логи Actions</a>`;
            addLog('Ошибка: Workflow не завершился вовремя');
            showSection('projectManagementSection', ['loadingSection']);
            if (createButton) {
                createButton.disabled = false;
                createButton.classList.remove('hidden');
            }
            return;
        }

        // Step 5: Show completed section
        if (progress) progress.style.width = '100%';
        if (progressText) progressText.innerText = '100% (5/5 этапа)';
        addLog('Проект готов');
        showSection('completedSection', ['loadingSection', 'previewSection', 'projectForm', 'projectManagementSection', 'loginForm']);
        zipDownloadUrl = isSingleZip ? `https://raw.githubusercontent.com/Endermanik13/AurumBotFiles/main/${encodeURIComponent(projectName)}/${encodeURIComponent(projectFiles[0].name)}` : 
                       `https://raw.githubusercontent.com/Endermanik13/AurumBotFiles/main/${encodeURIComponent(projectName)}/Инферно.zip`;
        if (responseDiv) {
            responseDiv.innerHTML = `Проект "${projectName}" успешно создан!<br>
                                    Местоположение: <a href="https://github.com/Endermanik13/AurumBotFiles/tree/main/${encodeURIComponent(projectName)}" target="_blank">github.com/Endermanik13/AurumBotFiles/tree/main/${projectName}</a>`;
        }
        addLog(`Проект "${projectName}" создан, ZIP: ${zipDownloadUrl}`);
    } catch (error) {
        if (responseDiv) responseDiv.innerHTML = `Ошибка: ${error.message}. <a href="https://github.com/Endermanik13/AurumBotFiles/actions" target="_blank">Проверить логи Actions</a>`;
        addLog(`Ошибка: ${error.message}`);
        showSection('projectManagementSection', ['loadingSection']);
        if (createButton) {
            createButton.disabled = false;
            createButton.classList.remove('hidden');
        }
    }
}
