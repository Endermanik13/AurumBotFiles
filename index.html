<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Проекты AurumBot</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #74ebd5, #acb6e5);
            color: #333;
        }
        .container {
            display: flex;
            max-width: 1000px;
            width: 100%;
            margin: 20px;
        }
        .main-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            max-width: 700px;
            width: 100%;
            text-align: center;
        }
        .log-section {
            background: #f5f5f5;
            padding: 20px;
            margin-left: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            width: 300px;
            max-height: 600px;
            overflow-y: auto;
        }
        .log-section h3 {
            margin-top: 0;
        }
        #logContent {
            font-size: 14px;
            text-align: left;
        }
        input[type="text"], input[type="password"] {
            padding: 12px;
            margin: 10px 0;
            font-size: 16px;
            width: calc(100% - 24px);
            border: 1px solid #ccc;
            border-radius: 6px;
        }
        .file-drop {
            border: 3px dashed #aaa;
            padding: 20px;
            margin: 15px 0;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .file-drop:hover, .file-drop.dragover {
            background: #e0e0e0;
        }
        .file-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }
        .file-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            background: #fafafa;
            margin: 5px 0;
            border-radius: 4px;
        }
        .file-list button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .file-list button:hover {
            background: #c82333;
        }
        button {
            padding: 12px;
            margin: 10px 5px;
            font-size: 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            width: calc(50% - 24px);
            transition: background 0.2s, transform 0.1s;
        }
        button:hover {
            background: #218838;
            transform: scale(1.05);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        #loginButton {
            background: #007bff;
            width: calc(100% - 24px);
            font-size: 18px;
            padding: 14px;
        }
        #loginButton:hover {
            background: #0056b3;
        }
        #response, #error {
            margin-top: 20px;
            font-size: 14px;
        }
        #response a, #error a {
            color: #007bff;
            text-decoration: none;
        }
        #response a:hover, #error a:hover {
            text-decoration: underline;
        }
        #previewSection img {
            max-width: 200px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        #progressBar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        #progress {
            height: 100%;
            background: #28a745;
            width: 0;
            transition: width 0.5s ease-in-out;
        }
        #progressText {
            font-size: 14px;
            margin: 5px 0;
        }
        #projectManagementSection, #projectForm, #previewSection, #loadingSection, #completedSection {
            display: none;
        }
        #loginForm {
            display: block;
        }
        .hidden {
            display: none;
        }
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .log-section {
                margin-left: 0;
                margin-top: 20px;
                width: 100%;
            }
            .main-section {
                max-width: 100%;
            }
            button {
                width: calc(100% - 24px);
            }
        }
        #projectList {
            margin-top: 20px;
        }
        #projectList ul {
            list-style: none;
            padding: 0;
        }
        #projectList li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            margin: 5px 0;
            background: #fafafa;
        }
        #projectList li a {
            color: #007bff;
            text-decoration: none;
            flex-grow: 1;
            text-align: left;
        }
        #projectList li a:hover {
            text-decoration: underline;
        }
        #projectList button {
            background: #dc3545;
        }
        #projectList button:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-section">
            <h1>Проекты AurumBot</h1>
            <div id="loginForm">
                <input type="password" id="githubToken" placeholder="Введите GitHub токен" required>
                <button id="loginButton" onclick="login()">Войти</button>
                <div id="error"></div>
            </div>
            <div id="projectManagementSection">
                <h2>Управление проектами</h2>
                <button onclick="showSection('projectForm', ['projectManagementSection'])">Создать новый проект</button>
                <button onclick="loadProjectList()">Обновить список</button>
                <div id="projectList"></div>
            </div>
            <div id="projectForm">
                <button onclick="showSection('projectManagementSection', ['projectForm'])">Управление проектами</button>
                <input type="text" id="projectName" placeholder="Введите название проекта" required>
                <label for="filesInput">Файлы или папка проекта:</label>
                <div class="file-drop" id="filesDrop" ondragover="event.preventDefault();" ondrop="handleDrop(event, 'filesInput')" ondragenter="this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')">
                    Перетащите файлы, папку или ZIP сюда или кликните для выбора
                </div>
                <input type="file" id="filesInput" multiple webkitdirectory accept=".png,.pdn,.zip" style="display: none;">
                <ul id="filesList" class="file-list"></ul>
                <button onclick="proceedToPreview()">Перейти к превью</button>
            </div>
            <div id="previewSection">
                <label>Файл превью (автовыбор: арт.png/art.png, если есть):</label>
                <div id="previewInfo"></div>
                <img id="previewImage" src="" alt="Превью" style="display: none;">
                <div class="file-drop" id="previewDrop" ondragover="event.preventDefault();" ondrop="handleDrop(event, 'previewFile')" ondragenter="this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')">
                    Перетащите новый файл превью (PNG) сюда или кликните для выбора
                </div>
                <input type="file" id="previewFile" accept=".png" style="display: none;">
                <ul id="previewFileList" class="file-list"></ul>
                <button onclick="showSection('projectForm', ['previewSection'])">Вернуться назад</button>
                <button id="createButton" onclick="createProject()">Создать проект</button>
            </div>
            <div id="loadingSection">
                <div id="progressBar"><div id="progress"></div></div>
                <div id="progressText">0% (0/5 этапа)</div>
                <button id="cancelButton" onclick="showSection('projectManagementSection', ['loadingSection']); document.getElementById('createButton').disabled = false; document.getElementById('createButton').classList.remove('hidden');">Вернуться назад</button>
            </div>
            <div id="completedSection">
                <p id="response"></p>
                <button onclick="resetForm()">Загрузить ещё</button>
                <button onclick="downloadZip()">Скачать</button>
                <button onclick="showSection('projectManagementSection', ['completedSection'])">Управление проектами</button>
            </div>
        </div>
        <div class="log-section">
            <h3>Логи</h3>
            <div id="logContent"></div>
        </div>
    </div>
    <script>
        let githubToken = '';
        let projectFiles = [];
        let previewFile = null;
        let zipDownloadUrl = '';

        function addLog(message) {
            const logContent = document.getElementById('logContent');
            if (logContent) {
                const logEntry = document.createElement('p');
                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logContent.appendChild(logEntry);
                logContent.scrollTop = logContent.scrollHeight;
            } else {
                console.error('Log content element not found');
            }
        }

        function showSection(showId, hideIds) {
            const showSection = document.getElementById(showId);
            if (showSection) {
                showSection.style.display = 'block';
                addLog(`Переключение на секцию: ${showId}`);
            } else {
                addLog(`Ошибка: Секция ${showId} не найдена`);
                console.error(`Section ${showId} not found`);
            }
            hideIds.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    section.style.display = 'none';
                } else {
                    addLog(`Ошибка: Секция ${id} не найдена для скрытия`);
                    console.error(`Section ${id} not found for hiding`);
                }
            });
        }

        function updateFileList(inputId, listId, fileArray) {
            const list = document.getElementById(listId);
            if (!list) {
                addLog(`Ошибка: Список ${listId} не найден`);
                return;
            }
            list.innerHTML = '';
            fileArray.forEach((file, index) => {
                const li = document.createElement('li');
                li.textContent = file.webkitRelativePath || file.name;
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Удалить';
                removeBtn.onclick = () => {
                    fileArray.splice(index, 1);
                    updateFileList(inputId, listId, fileArray);
                    if (inputId === 'previewFile' && !fileArray.length) {
                        const previewImage = document.getElementById('previewImage');
                        if (previewImage) previewImage.style.display = 'none';
                        previewFile = null;
                    }
                    addLog(`Удалён файл: ${file.name}`);
                };
                li.appendChild(removeBtn);
                list.appendChild(li);
            });
            const input = document.getElementById(inputId);
            if (input) input.value = '';
        }

        async function handleDrop(event, inputId) {
            event.preventDefault();
            event.target.classList.remove('dragover');
            const items = event.dataTransfer.items;
            const files = [];
            for (const item of items) {
                const entry = item.webkitGetAsEntry();
                if (entry) {
                    if (entry.isDirectory) {
                        const entries = await readDirectory(entry);
                        files.push(...entries);
                    } else {
                        files.push(item.getAsFile());
                    }
                }
            }
            if (inputId === 'filesInput') {
                projectFiles = projectFiles.concat(files);
                updateFileList('filesInput', 'filesList', projectFiles);
                addLog(`Загружено ${files.length} файлов/папок`);
            } else if (inputId === 'previewFile') {
                const file = files[0];
                if (file && file.type === 'image/png') {
                    previewFile = file;
                    updateFileList('previewFile', 'previewFileList', [previewFile]);
                    const reader = new FileReader();
                    reader.onload = () => {
                        const previewImage = document.getElementById('previewImage');
                        if (previewImage) {
                            previewImage.src = reader.result;
                            previewImage.style.display = 'block';
                        }
                    };
                    reader.readAsDataURL(file);
                    addLog(`Загружен файл превью: ${file.name}`);
                } else {
                    addLog('Ошибка: Превью должен быть PNG');
                }
            }
        }

        async function readDirectory(directory) {
            const reader = directory.createReader();
            const entries = [];
            const readEntries = () => new Promise(resolve => reader.readEntries(resolve));
            let results = await readEntries();
            while (results.length) {
                for (const entry of results) {
                    if (entry.isDirectory) {
                        const subEntries = await readDirectory(entry);
                        entries.push(...subEntries);
                    } else {
                        entries.push(await new Promise(resolve => entry.file(resolve)));
                    }
                }
                results = await readEntries();
            }
            return entries;
        }

        async function login() {
            githubToken = document.getElementById('githubToken').value;
            const errorDiv = document.getElementById('error');
            const loginButton = document.getElementById('loginButton');
            if (!errorDiv || !loginButton) {
                addLog('Ошибка: Элементы loginForm не найдены');
                console.error('loginForm elements not found');
                return;
            }
            if (!githubToken) {
                errorDiv.innerText = 'Введите GitHub токен.';
                addLog('Ошибка: Не введён GitHub токен');
                return;
            }

            errorDiv.innerText = 'Проверка токена...';
            loginButton.disabled = true;
            addLog('Проверка токена...');
            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                if (response.status === 200) {
                    const user = await response.json();
                    if (user.login === 'Endermanik13') {
                        showSection('projectManagementSection', ['loginForm', 'projectForm', 'previewSection', 'loadingSection', 'completedSection']);
                        errorDiv.innerText = '';
                        addLog('Успешная авторизация: Endermanik13');
                        loadProjectList();
                    } else {
                        errorDiv.innerText = 'Недействительный токен: не авторизован для Endermanik13.';
                        addLog('Ошибка: Токен не для Endermanik13');
                    }
                } else {
                    errorDiv.innerText = `Ошибка: ${response.statusText}`;
                    addLog(`Ошибка авторизации: ${response.statusText}`);
                }
            } catch (error) {
                errorDiv.innerText = `Ошибка: ${error.message}`;
                addLog(`Ошибка авторизации: ${error.message}`);
            } finally {
                loginButton.disabled = false;
            }
        }

        async function loadProjectList() {
            const projectList = document.getElementById('projectList');
            if (!projectList) {
                addLog('Ошибка: projectList не найден');
                return;
            }
            projectList.innerHTML = '<h3>Существующие проекты</h3><ul id="projects"></ul>';
            try {
                const response = await fetch('https://api.github.com/repos/Endermanik13/AurumBotFiles/contents/projects', {
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                if (response.status === 200) {
                    const contents = await response.json();
                    const ul = document.getElementById('projects');
                    if (!ul) return;
                    if (contents.length === 0) {
                        ul.innerHTML = '<li>Нет проектов</li>';
                        addLog('Папка projects пуста');
                    } else {
                        for (const item of contents) {
                            if (item.name.endsWith('.json')) {
                                const projectName = item.name.replace('.json', '');
                                const li = document.createElement('li');
                                const link = document.createElement('a');
                                link.href = `https://github.com/Endermanik13/AurumBotFiles/tree/main/${encodeURIComponent(projectName)}`;
                                link.target = '_blank';
                                link.textContent = projectName;
                                li.appendChild(link);
                                const deleteBtn = document.createElement('button');
                                deleteBtn.textContent = 'Удалить';
                                deleteBtn.onclick = () => deleteProject(projectName);
                                li.appendChild(deleteBtn);
                                ul.appendChild(li);
                            }
                        }
                        addLog('Загружен список проектов');
                    }
                } else if (response.status === 404) {
                    projectList.innerHTML = '<h3>Существующие проекты</h3><ul id="projects"><li>Нет проектов</li></ul>';
                    addLog('Папка projects пуста или отсутствует');
                } else {
                    addLog(`Ошибка загрузки проектов: ${response.statusText}`);
                }
            } catch (error) {
                addLog(`Ошибка загрузки проектов: ${error.message}`);
            }
        }

        async function deleteProject(projectName) {
            if (!confirm(`Удалить проект "${projectName}"?`)) return;
            addLog(`Удаление проекта ${projectName}...`);
            try {
                const jsonResponse = await fetch(`https://api.github.com/repos/Endermanik13/AurumBotFiles/contents/projects/${encodeURIComponent(projectName)}.json`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        message: `Delete project ${projectName}.json`,
                        sha: (await (await fetch(`https://api.github.com/repos/Endermanik13/AurumBotFiles/contents/projects/${encodeURIComponent(projectName)}.json`, {
                            headers: { 'Authorization': `Bearer ${githubToken}`, 'Accept': 'application/vnd.github.v3+json' }
                        })).json()).sha
                    })
                });
                if (jsonResponse.status !== 200) {
                    addLog(`Ошибка удаления ${projectName}.json: ${jsonResponse.statusText}`);
                    return;
                }

                const folderResponse = await fetch(`https://api.github.com/repos/Endermanik13/AurumBotFiles/contents/${encodeURIComponent(projectName)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        message: `Delete project folder ${projectName}`,
                        sha: (await (await fetch(`https://api.github.com/repos/Endermanik13/AurumBotFiles/contents/${encodeURIComponent(projectName)}`, {
                            headers: { 'Authorization': `Bearer ${githubToken}`, 'Accept': 'application/vnd.github.v3+json' }
                        })).json()).sha
                    })
                });
                if (folderResponse.status !== 200) {
                    addLog(`Ошибка удаления папки ${projectName}: ${folderResponse.statusText}`);
                    return;
                }

                addLog(`Проект ${projectName} удалён`);
                loadProjectList();
            } catch (error) {
                addLog(`Ошибка удаления проекта: ${error.message}`);
            }
        }

        document.getElementById('filesInput').addEventListener('change', () => {
            projectFiles = projectFiles.concat(Array.from(document.getElementById('filesInput').files));
            updateFileList('filesInput', 'filesList', projectFiles);
            addLog(`Выбрано ${projectFiles.length} файлов/папок`);
        });

        document.getElementById('previewFile').addEventListener('change', () => {
            previewFile = document.getElementById('previewFile').files[0];
            if (previewFile) {
                updateFileList('previewFile', 'previewFileList', [previewFile]);
                const reader = new FileReader();
                reader.onload = () => {
                    const previewImage = document.getElementById('previewImage');
                    if (previewImage) {
                        previewImage.src = reader.result;
                        previewImage.style.display = 'block';
                    }
                };
                reader.readAsDataURL(previewFile);
                addLog(`Выбран файл превью: ${previewFile.name}`);
            }
        });

        function proceedToPreview() {
            const projectName = document.getElementById('projectName').value;
            const responseDiv = document.getElementById('response');
            if (!projectName) {
                if (responseDiv) responseDiv.innerText = 'Введите название проекта.';
                addLog('Ошибка: Не указано название проекта');
                return;
            }
            if (projectFiles.length === 0) {
                if (responseDiv) responseDiv.innerText = 'Загрузите хотя бы один файл.';
                addLog('Ошибка: Не загружены файлы');
                return;
            }
            showSection('previewSection', ['projectForm', 'projectManagementSection', 'loginForm', 'loadingSection', 'completedSection']);
            const previewInfo = document.getElementById('previewInfo');
            if (!previewInfo) return;
            const autoPreview = projectFiles.find(f => f.name.toLowerCase() === 'арт.png' || f.name.toLowerCase() === 'art.png');
            if (autoPreview) {
                previewFile = autoPreview;
                previewInfo.innerText = `Автовыбор превью: ${autoPreview.name}`;
                updateFileList('previewFile', 'previewFileList', [autoPreview]);
                const reader = new FileReader();
                reader.onload = () => {
                    const previewImage = document.getElementById('previewImage');
                    if (previewImage) {
                        previewImage.src = reader.result;
                        previewImage.style.display = 'block';
                    }
                };
                reader.readAsDataURL(autoPreview);
                addLog(`Автовыбор превью: ${autoPreview.name}`);
            } else {
                previewInfo.innerText = 'Файл арт.png/art.png не найден. Загрузите файл превью.';
                addLog('Превью не найдено, требуется загрузка');
            }
        }

        async function createProject() {
            const projectName = document.getElementById('projectName').value;
            const responseDiv = document.getElementById('response');
            const progress = document.getElementById('progress');
            const progressText = document.getElementById('progressText');
            const createButton = document.getElementById('createButton');

            if (!projectName) {
                if (responseDiv) responseDiv.innerText = 'Введите название проекта.';
                addLog('Ошибка: Не указано название проекта');
                return;
            }

            // Check for duplicate project
            try {
                const projectCheck = await fetch(`https://api.github.com/repos/Endermanik13/AurumBotFiles/contents/projects/${encodeURIComponent(projectName)}.json`, {
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                if (projectCheck.status === 200) {
                    if (responseDiv) responseDiv.innerText = `Ошибка: Проект "${projectName}" уже существует.`;
                    addLog(`Ошибка: Проект "${projectName}" уже существует`);
                    return;
                } else if (projectCheck.status !== 404) {
                    if (responseDiv) responseDiv.innerText = `Ошибка проверки дублирования: ${projectCheck.statusText}`;
                    addLog(`Ошибка проверки дублирования: ${projectCheck.statusText}`);
                    return;
                }
            } catch (error) {
                if (responseDiv) responseDiv.innerText = `Ошибка проверки дублирования: ${error.message}`;
                addLog(`Ошибка проверки дублирования: ${error.message}`);
                return;
            }

            if (createButton) createButton.disabled = true;
            if (createButton) createButton.classList.add('hidden');
            showSection('loadingSection', ['previewSection', 'projectForm', 'projectManagementSection', 'loginForm', 'completedSection']);
            if (progress) progress.style.width = '0%';
            if (progressText) progressText.innerText = '0% (0/5 этапа)';
            addLog('Начато создание проекта');

            try {
                // Step 1: Process and upload files
                const fileMetadata = [];
                const isSingleZip = projectFiles.length === 1 && projectFiles[0].name.endsWith('.zip');
                const onlyPaintFiles = !isSingleZip && projectFiles.every(f => f.name.endsWith('.png') || f.name.endsWith('.pdn'));
                for (const file of projectFiles) {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    await new Promise(resolve => reader.onload = resolve);
                    const base64Content = reader.result.split(',')[1];
                    const path = file.webkitRelativePath || file.name;
                    const isPaintFile = path.endsWith('.png') || path.endsWith('.pdn');
                    const uploadPath = isSingleZip ? `${encodeURIComponent(projectName)}/${encodeURIComponent(path)}` : 
                                      onlyPaintFiles ? `${encodeURIComponent(projectName)}/${encodeURIComponent(path)}` : 
                                      `${encodeURIComponent(projectName)}/${isPaintFile ? 'Итог' : 'other'}/${encodeURIComponent(path)}`;
                    const uploadResponse = await fetch(`https://api.github.com/repos/Endermanik13/AurumBotFiles/contents/${uploadPath}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify({
                            message: `Add ${path} to ${projectName}`,
                            content: base64Content
                        })
                    });
                    if (uploadResponse.status !== 201) {
                        if (responseDiv) responseDiv.innerText = `Ошибка загрузки ${path}: ${uploadResponse.statusText}`;
                        addLog(`Ошибка загрузки ${path}: ${uploadResponse.statusText}`);
                        showSection('projectManagementSection', ['loadingSection']);
                        if (createButton) {
                            createButton.disabled = false;
                            createButton.classList.remove('hidden');
                        }
                        return;
                    }
                    fileMetadata.push({
                        path: path,
                        size_mb: (file.size / (1024 * 1024)).toFixed(2),
                        download_url: `https://raw.githubusercontent.com/Endermanik13/AurumBotFiles/main/${uploadPath}`
                    });
                    addLog(`Файл ${path} загружен в ${uploadPath}`);
                }
                if (progress) progress.style.width = '20%';
                if (progressText) progressText.innerText = '20% (1/5 этапа)';

                // Step 2: Trigger workflow
                await new Promise(resolve => setTimeout(resolve, 1000));
                if (progress) progress.style.width = '40%';
                if (progressText) progressText.innerText = '40% (2/5 этапа)';
                addLog('Запуск workflow...');

                const dispatchResponse = await fetch('https://api.github.com/repos/Endermanik13/AurumBotFiles/dispatches', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        event_type: 'create-project',
                        client_payload: {
                            project_name: projectName,
                            file_metadata: JSON.stringify(fileMetadata),
                            is_single_zip: isSingleZip
                        }
                    })
                });

                if (dispatchResponse.status !== 204) {
                    if (responseDiv) responseDiv.innerText = `Ошибка запуска workflow: ${dispatchResponse.statusText}`;
                    addLog(`Ошибка запуска workflow: ${dispatchResponse.statusText}`);
                    showSection('projectManagementSection', ['loadingSection']);
                    if (createButton) {
                        createButton.disabled = false;
                        createButton.classList.remove('hidden');
                    }
                    return;
                }

                // Step 3: Wait for workflow to start
                await new Promise(resolve => setTimeout(resolve, 2000));
                if (progress) progress.style.width = '60%';
                if (progressText) progressText.innerText = '60% (3/5 этапа)';
                addLog('Ожидание старта workflow...');

                // Step 4: Poll for workflow completion
                let workflowCompleted = false;
                let workflowId = null;
                for (let i = 0; i < 45; i++) {
                    const runsResponse = await fetch('https://api.github.com/repos/Endermanik13/AurumBotFiles/actions/runs', {
                        headers: {
                            'Authorization': `Bearer ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (runsResponse.status !== 200) {
                        if (responseDiv) responseDiv.innerHTML = `Ошибка проверки workflow: ${runsResponse.statusText}. <a href="https://github.com/Endermanik13/AurumBotFiles/actions" target="_blank">Проверить логи Actions</a>`;
                        addLog(`Ошибка проверки workflow: ${runsResponse.statusText}`);
                        showSection('projectManagementSection', ['loadingSection']);
                        if (createButton) {
                            createButton.disabled = false;
                            createButton.classList.remove('hidden');
                        }
                        return;
                    }
                    const runs = await runsResponse.json();
                    const run = runs.workflow_runs.find(r => r.event === 'repository_dispatch' && r.status !== 'completed');
                    if (run) {
                        workflowId = run.id;
                    } else if (workflowId) {
                        const runStatus = await fetch(`https://api.github.com/repos/Endermanik13/AurumBotFiles/actions/runs/${workflowId}`, {
                            headers: {
                                'Authorization': `Bearer ${githubToken}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        const runData = await runStatus.json();
                        if (runData.status === 'completed') {
                            if (runData.conclusion === 'success') {
                                workflowCompleted = true;
                            } else {
                                if (responseDiv) responseDiv.innerHTML = `Ошибка: Workflow завершился с ошибкой (${runData.conclusion}). <a href="https://github.com/Endermanik13/AurumBotFiles/actions/runs/${workflowId}" target="_blank">Проверить логи Actions</a>`;
                                addLog(`Ошибка: Workflow завершился с ошибкой (${runData.conclusion})`);
                                showSection('projectManagementSection', ['loadingSection']);
                                if (createButton) {
                                    createButton.disabled = false;
                                    createButton.classList.remove('hidden');
                                }
                                return;
                            }
                            break;
                        }
                    }
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }

                if (progress) progress.style.width = '80%';
                if (progressText) progressText.innerText = '80% (4/5 этапа)';
                addLog('Workflow завершён');

                if (!workflowCompleted) {
                    if (responseDiv) responseDiv.innerHTML = `Ошибка: Workflow не завершился вовремя. <a href="https://github.com/Endermanik13/AurumBotFiles/actions" target="_blank">Проверить логи Actions</a>`;
                    addLog('Ошибка: Workflow не завершился вовремя');
                    showSection('projectManagementSection', ['loadingSection']);
                    if (createButton) {
                        createButton.disabled = false;
                        createButton.classList.remove('hidden');
                    }
                    return;
                }

                // Step 5: Show completed section
                if (progress) progress.style.width = '100%';
                if (progressText) progressText.innerText = '100% (5/5 этапа)';
                addLog('Проект готов');
                showSection('completedSection', ['loadingSection', 'previewSection', 'projectForm', 'projectManagementSection', 'loginForm']);
                zipDownloadUrl = isSingleZip ? `https://raw.githubusercontent.com/Endermanik13/AurumBotFiles/main/${encodeURIComponent(projectName)}/${encodeURIComponent(projectFiles[0].name)}` : 
                               `https://raw.githubusercontent.com/Endermanik13/AurumBotFiles/main/${encodeURIComponent(projectName)}/Инферно.zip`;
                if (responseDiv) {
                    responseDiv.innerHTML = `Проект "${projectName}" успешно создан!<br>
                                            Местоположение: <a href="https://github.com/Endermanik13/AurumBotFiles/tree/main/${encodeURIComponent(projectName)}" target="_blank">github.com/Endermanik13/AurumBotFiles/tree/main/${projectName}</a>`;
                }
                addLog(`Проект "${projectName}" создан, ZIP: ${zipDownloadUrl}`);
            } catch (error) {
                if (responseDiv) responseDiv.innerHTML = `Ошибка: ${error.message}. <a href="https://github.com/Endermanik13/AurumBotFiles/actions" target="_blank">Проверить логи Actions</a>`;
                addLog(`Ошибка: ${error.message}`);
                showSection('projectManagementSection', ['loadingSection']);
                if (createButton) {
                    createButton.disabled = false;
                    createButton.classList.remove('hidden');
                }
            }
        }

        function downloadZip() {
            if (zipDownloadUrl) {
                window.open(zipDownloadUrl, '_blank');
                addLog('Скачивание ZIP...');
            } else {
                addLog('Ошибка: URL для скачивания ZIP не задан');
            }
        }

        function resetForm() {
            showSection('projectManagementSection', ['completedSection', 'previewSection', 'projectForm', 'loadingSection', 'loginForm']);
            const projectName = document.getElementById('projectName');
            const responseDiv = document.getElementById('response');
            const previewImage = document.getElementById('previewImage');
            const previewInfo = document.getElementById('previewInfo');
            if (projectName) projectName.value = '';
            projectFiles = [];
            previewFile = null;
            updateFileList('filesInput', 'filesList', projectFiles);
            updateFileList('previewFile', 'previewFileList', []);
            if (previewImage) previewImage.style.display = 'none';
            if (previewInfo) previewInfo.innerText = '';
            if (responseDiv) responseDiv.innerText = '';
            addLog('Форма сброшена для нового проекта');
            loadProjectList();
        }
    </script>
</body>
</html>
